<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">
    <title>Title</title>
    <script src="https://cdn.plot.ly/plotly-2.18.0.min.js"></script>
    <script src="https://unpkg.com/topojson-client"></script>
    <!--<script src="js/geojson.min.js"></script>-->
</head>
<body>
<div class="parent">
    <div class="inline-block-child" id="dropdowns"></div>
    <div class="inline-block-child" id="graph" style="width:600px;height:500px;"></div>
</div>
  <script>
      var dropdown_div = document.getElementById("dropdowns")
      dropdown_div.innerHTML = "<select id='variable'>\n" +
      "          <option value=\"sst\">Sea Surface Temp</option>\n" +
      "          <option value=\"tp\">Total Precipitation</option>\n" +
      "          <option value=\"u\">Viento Zonal</option>\n" +
      "          <option value=\"v\">Viento Meridional</option>\n" +
      "      </select>"

      var select_str = "<select id='year'>\n"
      for (let i = 2000; i<2021; i++){
          select_str += "<option value=" + String(i) + ">" + String(i) + "</option>"
      }
      select_str += "</select>"
      dropdown_div.innerHTML += select_str

      const var_selector = document.getElementById("variable")
      const year_selector = document.getElementById("year")
      GRAPH = document.getElementById('graph');
      var myplot;

      function arr_mult(arr, n){
          var rarr = Array()
          for (let i = 0; i<n;i++){
              rarr = rarr.concat(arr)
          }
          return rarr
      }

      function inner_arr_mult(arr, n){
          var rarr = Array()
          for (let i = 0; i<arr.length; i++){
              for (let l = 0; l<n;l++){
                  rarr = rarr.concat(arr[i])
              }
          }
          return rarr
      }

      function fetch_var_data(varname, years){
          const data_obj = years.map((y) =>
              (fetch(`https://raw.githubusercontent.com/tinSegur/fan-javascript/master/vis_data/${varname}/${varname}_data/${varname}-mean-${y}.json`)
                  .then((r) => r.json()))
          )
          return data_obj
      }

      function fetch_geo_data(varname, years){
          const data_obj = Promise.all(years.map((y) =>
              (fetch(`https://raw.githubusercontent.com/tinSegur/fan-javascript/master/vis_data/${varname}/${varname}_geo/${varname}-geo-${y}.json`)
                  .then((r) => r.json()))
          ))
          return data_obj
      }

      async function nullOrFetchData(varname, year){
          if (vars_graph_data[varname][year-2000] === null) {
              let data = await fetch(`https://raw.githubusercontent.com/tinSegur/fan-javascript/master/vis_data/${varname}/${varname}_data/${varname}-mean-${year}.json`).then((r) => r.json())
              let geo = await fetch(`https://raw.githubusercontent.com/tinSegur/fan-javascript/master/vis_data/${varname}/${varname}_geo/${varname}-geo-${year}.json`).then((r) => r.json())
              vars_graph_data[varname][year-2000] = [data, geo]
              console.log("Data insert")
              console.log([data, geo])
              return [data, geo]
          }
          else {
              console.log("Data retrieval")
              console.log(vars_graph_data[varname][year-2000])
              return vars_graph_data[varname][year-2000]
          }
      }

      async function update_graph(){
          let varname = var_selector.value
          let year = year_selector.value
          console.log([varname, year])
          let [var_data, var_geo] =  await nullOrFetchData(varname, year)

          let layer_update = []
          for (let j = 0; j<var_geo.length; j++){
              layer_update.push({
                  sourcetype: "geojson",
                  source: var_geo[j],
                  type: "line",
                  //color: "#"+(bam[j].value*100).toString(16),
                  linewidth: 0.5
              })
          }

          let trace_update = {
              lat: [inner_arr_mult(var_data.lat, var_data.lon.length)],
              lon: [arr_mult(var_data.lon, var_data.lat.length)],
              z: [var_data.data],
              type: 'scattermapbox',
              opacity:0.8,
              radius:8,
              reversescale: false,
              marker: {
                  color:var_data.data,
                  showscale:true,
                  cmax: Math.max(...var_data.data),
                  cmin: Math.min(...var_data.data)
              },
              hovertext: [var_data.data]
          }

          let layout_update = {
              title: 'Geo Heatmap',
              dragmode:'zoom',
              /*geo: {
                  scope:'south america',
                  showcountries:true
              },*/
              mapbox: {
                  style:'open-street-map',
                  center: {
                      lat:-48,
                      lon:-73
                  },
                  layers: layer_update
              },
              coloraxis: {
                  colorscale: "Jet"
              }
          }
          Plotly.update(GRAPH, trace_update, layout_update)
      }


      const vars_graph_data = {
          sst: Array.from(Array(21), (x, i) => null),
          tp: Array.from(Array(21), (x, i) => null),
          u: Array.from(Array(21), (x, i) => null),
          v: Array.from(Array(21), (x, i) => null)
      }

      /*const year_int = Array.from(Array(21), (x, i) => 2000+i)
      const sst_data = fetch_var_data('sst', year_int)
      const sst_geo = fetch_geo_data('sst', year_int)

      const tp_data = fetch_var_data('tp', year_int)
      const tp_geo = fetch_geo_data('tp', year_int)

      const u_data = fetch_var_data('u', year_int)
      const u_geo = fetch_geo_data('u', year_int)

      const v_data = fetch_var_data('v', year_int)
      const v_geo = fetch_geo_data('v', year_int)


      Promise.all([sst_data, sst_geo, tp_data, tp_geo, u_data, u_geo, v_data, v_geo]).then((reponses) => {
          const sst_obj = {
              data: responses[0],
              geo: responses[1]
          };

          const tp_obj = {
              data: responses[2],
              geo: responses[3]
          }

          const u_obj = {
              data: reponses[4],
              geo: responses[5]
          }

          const v_obj = {
              data: responses[6],
              geo: reponses[7]
          }
              })*/

      const init_data = nullOrFetchData(var_selector.value, year_selector.value)

      /*const data = fetch("https://raw.githubusercontent.com/tinSegur/fan-javascript/master/vis_data/sst/sst_data/sst-mean-2000.json")
                .then((r) => r.json());*/
      /*const contours = fetch("https://raw.githubusercontent.com/tinSegur/fan-javascript/master/vis_data/sst/sst_geo/sst-geo-2000.json")
                .then((r) => r.json())*/


      Promise.all([init_data]).then( (draw_data) => {
        var geo = draw_data[0][1]
        var data = draw_data[0][0]

        var layer_obj = []
        for (let j = 0; j<geo.length; j++){
          layer_obj.push({
            sourcetype: "geojson",
            source: geo[j],
            type: "line",
            //color: "#"+(bam[j].value*100).toString(16),
            linewidth: 0.5
          })
        }
        console.log(layer_obj)

        var data_obj = [{
          lon: arr_mult(data.lon, 101),
          lat: inner_arr_mult(data.lat, 161),
          z: data.data.flat(4),
          type: 'scattermapbox',
          opacity:0.8,
          radius:8,
          reversescale: false,
          marker: {
            coloraxis: 'coloraxis',
            color:data.data.flat(),
          },
          hovertext: data.data.flat()
        }];


        var layout = {
          title: 'Geo Heatmap',
          dragmode:'zoom',
          /*geo: {
              scope:'south america',
              showcountries:true
          },*/
          mapbox: {
            style:'open-street-map',
            center: {
              lat:-48,
              lon:-73
            },
            layers: layer_obj
          },
          coloraxis: {
              colorscale: "Jet"
          }
        }

        myplot = Plotly.newPlot(GRAPH, data_obj, layout);
        var_selector.addEventListener("change", update_graph, false)
        year_selector.addEventListener("change", update_graph, false)
      })
  </script>

</body>
</html>